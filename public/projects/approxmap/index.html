<!DOCTYPE html>
<html lang="en-us">
<head>
  
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-51110003-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-51110003-2');
    </script>

  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">


<title>Approxmap - An R package to explore macro trends in sequential data - Gurudev Ilangovan</title>
<meta property="og:title" content="Approxmap - An R package to explore macro trends in sequential data - Gurudev Ilangovan">
<meta property="og:type" content="article">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://amber.rbind.io/projects/img/approxmapR.jpg" >
  

<meta property="description" content="An R package for sequential data mining">
<meta property="og:description" content="An R package for sequential data mining">


<meta name="twitter:creator" content="">

<meta name="description" content="A portfolio for my data science projects, analyses and blogs about things that I&#39;ve been learning.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="twitter:creator" content="">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/owl.carousel.css">
<link rel="stylesheet" href="/css/owl.theme.css">



<link href="/css/style.default.css" rel="stylesheet" id="theme-stylesheet">

<link href="/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="/img/favicon.png">


<link rel="stylesheet" href="/css/github-gist.css" rel="stylesheet" id="theme-stylesheet">




<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-51110003-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              
<div id="sidebar" class="col-sb-fixedpos col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="/">Gurudev Ilangovan</a></h1>

    <ul class="sidebar-menu">
      
      
        <li><a href="/about/">About</a></li>
      
        <li><a href="/projects/">Projects</a></li>
      
        <li><a href="/analyses/">Analyses</a></li>
      
        <li><a href="/blog/">Blog</a></li>
      
        <li><a href="/resume/">Resume</a></li>
      
        <li><a href="/contact/">Get in Touch</a></li>
      

       



 

      

 

      
 

    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/GuruIlan" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  <a href="mailto:ilangurudev@gmail.com" data-animate-hover="pulse" class="email">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://www.linkedin.com/in/gurudevilangovan/" data-animate-hover="pulse">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
  
<a href="https://www.github.com/ilangurudev">
  <i class="fa fa-github"></i>
</a>




</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2018 Gurudev Ilangovan
        
        | Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a> | Additional styling from <a href="https://amber.rbind.io/">amber.rbind.io</a>

      </p>
    </div>
  </div>
</div>

<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background col-main-fixedpos">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="/">Gurudev Ilangovan</a></h1>
</div>


            <div class="row">
                  <div class="col-sm-4">
                    <div class="image">
                      <img src="/projects/img/approxmapR.jpg" class="img-responsive" alt="">
                    </div>
                  </div>

                  <div class="col-md-8">
                      <h2>Approxmap - An R package to explore macro trends in sequential data</h2>
                          <p class="author-category">
                            Gurudev Ilangovan
                          </p>

                          <p class="date-comments">
                          <i class="fa fa-calendar-o"></i> October 1, 2017
                          </p>

                          
                  
                      </div>
                    </div>
                  </br>

<div class="row">
   <div class="content-column-content">
          <div class="col-lg-8">

<div id="TOC">
<ul>
<li><a href="#setting-up">Setting Up</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#workflow">Workflow</a><ul>
<li><a href="#general-instructions">General Instructions</a></li>
<li><a href="#aggregate-the-data">1. Aggregate the data</a></li>
<li><a href="#cluster-the-data">2. Cluster the data</a></li>
<li><a href="#extract-the-patterns">3. Extract the patterns</a></li>
<li><a href="#formatted-output">4. Formatted output</a></li>
</ul></li>
<li><a href="#using-tidyverse-to-fully-exploit-approxmapr">Using <code>tidyverse</code> to fully exploit approxmapR</a></li>
</ul>
</div>

<p>ApproxmapR is an R package for the approxmap algorithm, used for exploratory data analysis of sequential data. When we have longitudinal data and we want to find out the underlying patterns, we use approxmap. <code>approxmapR</code> aims to provide a consistent and tidy api for using the algorithm in R. This vignette aims to demonstrate the basic workflow of approxmapR.</p>
<p>Installation is simple.</p>
<pre><code>install.packages(&quot;devtools&quot;)
devtools::install_github(&quot;ilangurudev/approxmapR&quot;)</code></pre>
<div id="setting-up" class="section level1">
<h1>Setting Up</h1>
<p>To load the package we use,</p>
<pre class="r"><code>library(approxmapR)</code></pre>
<p>Though, it is not required, we strongly encourage you to use the <code>tidyverse</code> package. The <code>approxmapR</code> was designed with the same paradigm and hence works cohesively with <code>tidyverse</code>. To install and load,</p>
<pre><code>install.packages(&quot;tidyverse&quot;)</code></pre>
<p>To load,</p>
<pre class="r"><code>library(tidyverse)</code></pre>
</div>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<p>Now that we have loaded and installed everything we need, let’s jump into the problem and motivation for using approxmap. Let’s say you have a dataset that looks like this:</p>
<p>The base data is from the package <code>TraMineR</code> (it has been tweaked a little for our problem) and provides the employment status of 712 individuals for each month from 1993 to 1998. Now you are interested in answering the question, “<strong>What are the general sequences of employment that people go through?</strong>”. Since there are 712 people, it is not possible for us to decipher what the patterns are by visual inspection. Looking for exact sequences that are present in <em>all</em> these people will get us nowhere.</p>
<p>So we need to methodically formulate the solution. Let’s look at some key terms necessary for doing that:</p>
<ol style="list-style-type: decimal">
<li><strong>Item</strong>: An item is an event that belongs to an ID. We are actually interested in seeing what the pattern of the items are.</li>
<li><strong>Itemset</strong>: An itemset is a collection of items within which the order of items doesn’t matter. A typical example of an itemset is <em>bread and butter</em>. Itemsets are used when the aggregation (more on that later) is typically such that it includes several items.</li>
<li><strong>Sequence</strong>: A sequence is an ordered collection of itemsets. This means that the way they are ordered matters.</li>
<li><strong>Weighted Sequence</strong>: Several sequences put together after multiple alignment. Multiple alignment is beyond the scope of this vignette but please check <a href="https://en.wikipedia.org/wiki/Levenshtein_distance">this small example</a> to get an intuition.</li>
</ol>
<p>Hence, every person (id) in our dataset represents a sequence. We therefore have 712 sequences. Though we can extract a general pattern from all these sequences, a better idea would be to</p>
<ol style="list-style-type: decimal">
<li>Group similar sequences into clusters</li>
<li>Create a weighted sequence for each cluster</li>
<li>Extract the items that are present in a position a specified percent of the time.</li>
</ol>
<p>The above steps are the crux of the approxmap algorithm.</p>
</div>
<div id="workflow" class="section level1">
<h1>Workflow</h1>
<p>Let us go through the sequence of steps involved in analyzing the mvad dataset using approxmap. Please note that this version of approxmap only supports unique items within an itemset.</p>
<div id="general-instructions" class="section level2">
<h2>General Instructions</h2>
<ol style="list-style-type: decimal">
<li>Any time you need more information on a particular function, you could, as always, use <code>?function_name</code> to get detailed help.</li>
<li>The package uses the <code>%&gt;%</code> operator (Ctrl/Cmd + Shift + M). This means you can move from one function to another seamlessly.</li>
</ol>
</div>
<div id="aggregate-the-data" class="section level2">
<h2>1. Aggregate the data</h2>
<p>For the algorithm to create sequences, it needs data in the form:</p>
<p>So basically we need to aggregate the dataset i.e. go from dates to aggregations (called as period) in the package. For this we use the <code>aggregate_sequences()</code> function. The aggregate sequences takes in a number of parameters. <code>format</code> is used to specify the date format, <code>unit</code> is used to specify the unit of aggregation - day, week, month and so on, <code>n_units</code> is used to specify the number of units to aggregate. So if unit is “week” and n_units is 4, 4 weeks becomes the unit of aggregation. For more information please refer to the function documentation.</p>
<p>The function also displays some useful statistics about the sequences.</p>
<pre class="r"><code>(agg_seqs &lt;- 
  mvad %&gt;%
  aggregate_sequences(format = &quot;%Y-%m-%d&quot;, unit = &quot;month&quot;, n_units = 3))</code></pre>
<p><code>approxmapR</code> also allows for pre-aggregated data through the <code>pre_aggregated()</code> function. This function ensures all the right classes are aplied to the data before moving on to the next steps.</p>
<pre><code>pre_aggregated_df %&gt;%
  pre_aggregated()</code></pre>
</div>
<div id="cluster-the-data" class="section level2">
<h2>2. Cluster the data</h2>
<p>The next step involves one of the more computationally intensive steps of the algorithm - clustering. To cluster we simply need to pass an aggregated dataframe and the <code>k</code> parameter, which refers to the number of nearest neighbours to consider while clustering. In essense, lower the <code>k</code> value, higher the number of clusters and vice-versa. Selecting the right value of k is a judgement call that is very specific to the data.</p>
<p>Since it is a heavy task, we have used caching to store the results. What caching does is compares the aggregated dataframe to the one in memory and if it is identical, then uses the previously computed results to cluster. For turning caching off, use the parameter <code>use_cache=FALSE</code></p>
<pre class="r"><code>(cluster_seqs &lt;- 
    agg_seqs %&gt;%
    cluster_knn(k = 5))</code></pre>
<p>The output of the cluster_knn function is a dataframe with 3 columns -</p>
<ol style="list-style-type: decimal">
<li>cluster (cluster_id)</li>
<li>df_sequences (dataframes of id and sequences corresponding to the cluster)</li>
<li>n which refers to the number of sequences in the cluster and is used to sort the dataframe</li>
</ol>
</div>
<div id="extract-the-patterns" class="section level2">
<h2>3. Extract the patterns</h2>
<p>Now that we have clustered, the next step is to calculate a weighted sequence for each cluster. We can do this using the <code>get_weighted_sequence()</code> function. However, the <code>filter_pattern()</code> function automatically does this for us. So all we need to do is call the <code>filter_pattern()</code> with the required threshold and an optional pattern name (default is consensus).</p>
<p>The <code>threshold</code> parameter is used to specify the specify the proportion of sequeneces the item must have been present in.</p>
<pre class="r"><code>(results &lt;- 
  cluster_seqs %&gt;%
      filter_pattern(threshold = 0.3, pattern_name = &quot;variation&quot;))</code></pre>
<p>We can also chain multiple <code>filter_pattern()</code> functions to keep adding patterns.</p>
<pre><code>results &lt;- 
  mvad %&gt;%
    aggregate_sequences(format = &quot;%Y-%m-%d&quot;, unit = &quot;month&quot;, n_units = 3, summary_stats=FALSE) %&gt;%
      cluster_knn(k = 15) %&gt;%
        filter_pattern(threshold = 0.3, pattern_name = &quot;variation&quot;) %&gt;%
          filter_pattern(threshold = 0.4, pattern_name = &quot;consensus&quot;) </code></pre>
</div>
<div id="formatted-output" class="section level2">
<h2>4. Formatted output</h2>
<p>Though all the algorithmic work is done, the output is hardly readable as the objects of interest are all present as classes. We have not “prettified” the output by design because concealing it would really inhibit additional explaratory possibilities. Instead, we have a simple function that can be called for this - <code>format_sequence()</code></p>
<pre class="r"><code>results %&gt;% format_sequence() </code></pre>
<p>Since markdown by default limits the screen content the important output gets truncated. So I have used another paramter called <code>kable</code> which can be safely ignored if it doesn’t make sense.
The format_sequence also has a parameter called <code>compare</code> which when TRUE lists the patterns within a cluster row-by-row. The r function <code>View()</code> can be chained to opened the output dataframe in the built-in viewer but sometimes the output strings are too large to be viewed there. So we can chain the readr function <code>write_csv()</code> to save the output and explore the results in a text editor or excel.</p>
<pre class="r"><code>results %&gt;%
  filter_pattern(threshold = 0.4, pattern_name = &quot;consensus&quot;) %&gt;%
  format_sequence(compare=TRUE) %&gt;%
  kable()</code></pre>
<pre><code>approxmap_results %&gt;% write_csv(&quot;approxmap_results.csv&quot;)</code></pre>
</div>
</div>
<div id="using-tidyverse-to-fully-exploit-approxmapr" class="section level1">
<h1>Using <code>tidyverse</code> to fully exploit approxmapR</h1>
<p>The output is what is called as a tibble (a supercharged dataframe) that makes it possible to do things like storing a list of tibbles (df_sequences) in a column. To inspect the say the first 2 rows, we can use standard <code>dplyr</code> commands.</p>
<pre class="r"><code>df_sequences &lt;- 
  cluster_seqs %&gt;%
      top_n(2) %&gt;%
        pull(df_sequences)

df_sequences</code></pre>
<p>To explore these sequences, we also have tidy print methods. The functional programming toolkit for R, <code>purrr</code> provides an efficient means to fully exploit such outputs.</p>
<pre class="r"><code>df_sequences %&gt;%
          map(function(df_cluster){
            df_cluster %&gt;%
              mutate(sequence = map_chr(sequence, format_sequence))
          })</code></pre>
</div>

      
       </div>
     </div>
   </div>





        <a href="#" class="back-to-top">
        <i class="fa fa-arrow-circle-o-up" aria-hidden="true"></i>

        </a>

         <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ilangurudev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
   

          </div>
      </div>
  </div>
  <script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.js"> </script>
<script src="/js/ekko-lightbox.js"></script>
<script src="/js/jquery.scrollTo.min.js"></script>
<script src="/js/masonry.pkgd.min.js"></script>
<script src="/js/imagesloaded.pkgd.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/front.js"></script>
<script src="/js/backtotop.js"></script> 
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>
